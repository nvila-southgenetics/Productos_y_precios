import { createClient } from '@supabase/supabase-js'
import { Database } from '../src/types/database'

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!
const supabaseServiceKey = process.env.SUPABASE_SERVICE_ROLE_KEY!

if (!supabaseUrl || !supabaseServiceKey) {
  console.error('Missing Supabase environment variables')
  console.error('Required: NEXT_PUBLIC_SUPABASE_URL, SUPABASE_SERVICE_ROLE_KEY')
  process.exit(1)
}

const supabase = createClient<Database>(supabaseUrl, supabaseServiceKey, {
  auth: {
    autoRefreshToken: false,
    persistSession: false
  }
})

async function seedDatabase() {
  console.log('üå± Iniciando seed de la base de datos...')

  try {
    // Obtener el primer usuario de la base de datos
    console.log('üë§ Obteniendo usuario...')
    const { data: users, error: usersError } = await supabase.auth.admin.listUsers()

    if (usersError) {
      throw usersError
    }

    if (!users || users.users.length === 0) {
      console.error('‚ùå No hay usuarios en la base de datos.')
      console.error('Por favor, crea un usuario primero registr√°ndote en la aplicaci√≥n.')
      console.error('Luego ejecuta el seed nuevamente.')
      process.exit(1)
    }

    const userId = users.users[0].id
    console.log(`‚úÖ Usuario encontrado: ${users.users[0].email}`)

    // Crear productos de ejemplo
    console.log('üì¶ Creando productos de ejemplo...')
    
    const products = [
      {
        name: 'Onco B√°sico',
        sku: 'ONCO-001',
        description: 'Panel b√°sico de oncolog√≠a con an√°lisis gen√©tico fundamental',
        base_price: 4000,
        currency: 'USD',
        user_id: userId
      },
      {
        name: 'Onco Plus',
        sku: 'ONCO-002',
        description: 'Panel avanzado de oncolog√≠a con an√°lisis completo y seguimiento',
        base_price: 6000,
        currency: 'USD',
        user_id: userId
      },
      {
        name: 'NIPT',
        sku: 'NIPT-001',
        description: 'Prueba prenatal no invasiva para detecci√≥n de anomal√≠as cromos√≥micas',
        base_price: 300,
        currency: 'USD',
        user_id: userId
      }
    ]

    const { data: insertedProducts, error: productsError } = await supabase
      .from('products')
      .insert(products)
      .select()

    if (productsError) {
      throw productsError
    }

    console.log(`‚úÖ ${insertedProducts.length} productos creados`)

    // Crear overrides de ejemplo para M√©xico
    console.log('üá≤üáΩ Creando overrides para M√©xico...')
    
    const mexicoOverrides = [
      {
        product_id: insertedProducts[0].id, // Onco B√°sico
        country_code: 'MX',
        overrides: {
          salesCommissionPct: 0.07, // 7% de comisi√≥n
          externalCourierUSD: 25,   // $25 USD courrier internacional
          kitCostUSD: 15            // $15 USD costo del kit
        }
      },
      {
        product_id: insertedProducts[1].id, // Onco Plus
        country_code: 'MX',
        overrides: {
          salesCommissionPct: 0.06, // 6% de comisi√≥n
          externalCourierUSD: 30,   // $30 USD courrier internacional
          kitCostUSD: 20            // $20 USD costo del kit
        }
      },
      {
        product_id: insertedProducts[2].id, // NIPT
        country_code: 'MX',
        overrides: {
          salesCommissionPct: 0.05, // 5% de comisi√≥n
          externalCourierUSD: 15,   // $15 USD courrier internacional
          kitCostUSD: 8             // $8 USD costo del kit
        }
      }
    ]

    const { error: overridesError } = await supabase
      .from('product_country_overrides')
      .insert(mexicoOverrides)

    if (overridesError) {
      throw overridesError
    }

    console.log('‚úÖ Overrides para M√©xico creados')

    // Crear overrides de ejemplo para Argentina
    console.log('üá¶üá∑ Creando overrides para Argentina...')
    
    const argentinaOverrides = [
      {
        product_id: insertedProducts[0].id, // Onco B√°sico
        country_code: 'AR',
        overrides: {
          salesCommissionPct: 0.05, // 5% de comisi√≥n
          externalCourierUSD: 20,   // $20 USD courrier internacional
          kitCostUSD: 12            // $12 USD costo del kit
        }
      },
      {
        product_id: insertedProducts[1].id, // Onco Plus
        country_code: 'AR',
        overrides: {
          salesCommissionPct: 0.04, // 4% de comisi√≥n
          externalCourierUSD: 25,   // $25 USD courrier internacional
          kitCostUSD: 18            // $18 USD costo del kit
        }
      }
    ]

    const { error: arOverridesError } = await supabase
      .from('product_country_overrides')
      .insert(argentinaOverrides)

    if (arOverridesError) {
      throw arOverridesError
    }

    console.log('‚úÖ Overrides para Argentina creados')

    console.log('üéâ Seed completado exitosamente!')
    console.log('\nüìã Resumen:')
    console.log(`- ${insertedProducts.length} productos creados`)
    console.log('- Overrides configurados para M√©xico y Argentina')
    console.log('\nüöÄ Puedes iniciar la aplicaci√≥n con: pnpm dev')

  } catch (error) {
    console.error('‚ùå Error durante el seed:', error)
    process.exit(1)
  }
}

seedDatabase()
